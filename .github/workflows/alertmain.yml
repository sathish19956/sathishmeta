name: Field alert mail

on:
  push:
    branches:
      - main
    paths:
      - 'profiles/*.profile'
      - 'permissionSets/*.permissionset'
  pull_request:
    branches:
      - main
    paths:
      - 'profiles/*.profile'
      - 'permissionSets/*.permissionset'

jobs:
  send-alert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Check for FLS changes on target fields
        id: fls_check
        run: |
          # Fetch the base and head of the push or PR
          git fetch origin

          # Determine the base and head SHAs
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          fi

          # Get list of changed .profile or .permissionset files
          CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA \
            | grep -E 'src/profiles/.*\.profile$|src/permissionSets/.*\.permissionset$' || true)

          # Initialize flag
          FLS_CHANGED=false

          # Check each changed file for specific field permissions
          for FILE in $CHANGED_FILES; do
            if git diff $BASE_SHA $HEAD_SHA -- "$FILE" | \
              grep -E 'testing_of_the_git_alert__c'; then
              FLS_CHANGED=true
              break
            fi
          done

          # Export output so the next step can read it
          echo "FLS_CHANGED=$FLS_CHANGED" >> $GITHUB_OUTPUT

      - name: Send alert email
        if: steps.fls_check.outputs.FLS_CHANGED == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.example.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Field Level Security Change Alert"
          to: prashkulkarni7064@gmail.com,kanumalamanoj@gmail.com
          from: ${{ secrets.EMAIL_FROM }}
          body: |
            Attention:

            A change has been detected on field-level security for the following fields:
            - testing_of_the_git_alert__c
            

            Please review the changes in the repository:
            ${{ github.repository }}
            Commit/PR: ${{ github.sha }}
            Author: ${{ github.actor }}
            Link: https://github.com/${{ github.repository }}/commit/${{ github.sha }}

            Regards,
            GitHub Actions
